<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>天陽会透析解析支援ツール</title>
  <style>
    :root{
      --bg:#fff; --text:#0b1220; --muted:#6b7280; --accent:#0b5ed7; --ok:#0f9d58; --warn:#d9534f;
      --card-radius:10px; --gap:12px; --maxw:760px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Noto Sans JP", system-ui, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
      padding:18px;
      box-sizing:border-box;
    }
    .wrap{max-width:var(--maxw);margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#0b7285);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    h1{margin:0;font-size:18px}
    .author{font-size:12px;color:var(--muted);text-align:right}
    .card{background:#fff;border-radius:var(--card-radius);padding:12px;border:1px solid #eef2f6;box-shadow:0 6px 18px rgba(11,18,34,0.04)}
    .grid{display:grid;grid-template-columns:1fr 300px;gap:var(--gap)}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:9px;border-radius:8px;border:1px solid #e6eef6;font-size:14px;box-sizing:border-box}
    .row{display:flex;gap:8px}
    .btn{background:var(--accent);color:#fff;padding:9px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.secondary{background:transparent;border:1px solid #e6eef6;color:var(--muted)}
    .btn.ghost{background:#f8fafc;color:var(--muted);border:1px solid #eef2f6}
    .small{font-size:12px;color:var(--muted)}
    .metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
    @media(max-width:520px){.metrics{grid-template-columns:1fr}}
    .metric{padding:10px;border-radius:8px;border:1px solid #f0f4f8;background:#fbfdff}
    .metric .val{font-weight:800;font-size:18px;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #f0f4f8;text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:700}
    .ok{color:var(--ok);font-weight:800}
    .warn{color:var(--warn);font-weight:800}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .advice{margin-top:10px;padding:10px;border-radius:8px;background:#f8fbff;border:1px solid #e6f0ff}
    @media print{ .btn, .author {display:none} .wrap{max-width:210mm;padding:12mm} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">天陽</div>
        <div>
          <h1>天陽会透析解析支援ツール</h1>
          <div class="small">回診で使えるコンパクトUI・A4印刷対応</div>
        </div>
      </div>
      <div class="author">作成者：CE（U）</div>
    </header>

    <main class="grid">
      <!-- Left: Inputs -->
      <section>
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center">
            <div style="flex:1">
              <label for="patientId">患者ID</label>
              <input id="patientId" type="text" placeholder="例: P12345">
            </div>
            <div style="width:150px">
              <label for="examDate">日付</label>
              <input id="examDate" type="date">
            </div>
          </div>

          <div style="margin-top:10px" class="small">主要検査を入力してください（半角数字）</div>

          <div style="margin-top:10px" class="row">
            <div style="flex:1">
              <label for="K">K (mmol/L)</label>
              <input id="K" type="text" inputmode="decimal" placeholder="4.2">
            </div>
            <div style="width:120px">
              <label for="Alb">Alb (g/dL)</label>
              <input id="Alb" type="text" inputmode="decimal" placeholder="3.8">
            </div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
            <div><label for="Ca">Ca (mg/dL)</label><input id="Ca" type="text" inputmode="decimal" placeholder="8.6"></div>
            <div><label for="P">P (mg/dL)</label><input id="P" type="text" inputmode="decimal" placeholder="5.2"></div>
            <div><label for="iPTH">iPTH (pg/mL)</label><input id="iPTH" type="text" inputmode="numeric" placeholder="120"></div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
            <div><label for="Hb">Hb (g/dL)</label><input id="Hb" type="text" inputmode="decimal" placeholder="10.5"></div>
            <div><label for="Fe">Fe (μg/dL)</label><input id="Fe" type="text" inputmode="decimal" placeholder="60"></div>
            <div><label for="TIBC">TIBC (μg/dL)</label><input id="TIBC" type="text" inputmode="decimal" placeholder="300"></div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
            <div><label for="Ferritin">Ferritin (ng/mL)</label><input id="Ferritin" type="text" inputmode="decimal" placeholder="150"></div>
            <div><label for="BUNpre">BUN pre</label><input id="BUNpre" type="text" inputmode="decimal" placeholder="60"></div>
            <div><label for="BUNpost">BUN post</label><input id="BUNpost" type="text" inputmode="decimal" placeholder="20"></div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
            <div><label for="dialysisTime">透析時間 (分)</label><input id="dialysisTime" type="text" inputmode="numeric" placeholder="240"></div>
            <div><label for="UF">除水量 (kg)</label><input id="UF" type="text" inputmode="decimal" placeholder="2.0"></div>
            <div><label for="height">身長 (cm)</label><input id="height" type="text" inputmode="numeric" placeholder="160"></div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
            <div><label for="weightPre">体重(透析前) (kg)</label><input id="weightPre" type="text" inputmode="decimal" placeholder="60"></div>
            <div><label for="weightPost">体重(透析後) (kg)</label><input id="weightPost" type="text" inputmode="decimal" placeholder="58"></div>
            <div>
              <label for="idwg">IDWG (kg) 自動</label>
              <input id="idwg" type="text" readonly placeholder="自動計算">
            </div>
          </div>

          <hr style="margin:10px 0;border:none;border-top:1px solid #f0f4f8">

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <label for="saltManual">塩分（手入力が優先） g/day</label>
              <input id="saltManual" type="text" inputmode="decimal" placeholder="例: 6">
              <div class="note">手入力があればそれを使用します。</div>
            </div>
            <div>
              <label for="urineNa">尿Na (mEq/L)（任意）</label><input id="urineNa" type="text" inputmode="decimal" placeholder="例: 50">
              <label for="urineVol" style="margin-top:6px">24h尿量 (L)（任意）</label><input id="urineVol" type="text" inputmode="decimal" placeholder="例: 0.5">
            </div>
          </div>

          <div style="margin-top:8px" class="small">または</div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <div style="flex:1">
              <label for="idwgInput">IDWGベース推定（透析前後体重差）</label>
              <input id="idwgInput" type="text" inputmode="decimal" placeholder="例: 1.0">
            </div>
            <button id="estimateSalt" class="btn" style="height:40px;align-self:end">推定</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button id="runAnalyze" class="btn">解析実行</button>
            <button id="clearBtn" class="btn ghost">クリア</button>
            <button id="printBtn" class="btn secondary">A4で印刷</button>
            <div style="margin-left:auto" class="small">スマホ対応</div>
          </div>

          <div class="note">※推定は目安です。正確な評価は食事記録や尿検査を推奨します。</div>
        </div>
      </section>

      <!-- Right: Reference & Results -->
      <aside>
        <div class="card">
          <strong>目標値（抜粋）</strong>

          <div class="metrics" style="margin-top:10px">
            <div class="metric"><div class="small">spKt/V</div><div class="val">≥ 1.4</div></div>
            <div class="metric"><div class="small">Hb</div><div class="val">10–12 g/dL</div></div>
            <div class="metric"><div class="small">TSAT</div><div class="val">≥ 20%</div></div>
            <div class="metric"><div class="small">Ferritin</div><div class="val">100–300 ng/mL</div></div>
            <div class="metric"><div class="small">P</div><div class="val">3.5–5.5 mg/dL</div></div>
            <div class="metric"><div class="small">補正Ca</div><div class="val">8.4–9.5 mg/dL</div></div>
            <div class="metric"><div class="small">iPTH</div><div class="val">60–240 pg/mL</div></div>
            <div class="metric"><div class="small">K</div><div class="val">3.5–5.5 mmol/L</div></div>
          </div>

          <hr style="margin:10px 0">

          <div class="small"><strong>計算式</strong></div>
          <div class="small" style="margin-top:6px">
            <div>補正Ca = Ca + 0.8 × (4.0 − Alb)</div>
            <div>TSAT = Fe / TIBC × 100</div>
            <div>spKt/V ≈ −ln(BUNpost/BUNpre − 0.008×t) + (4 − 3.5×(BUNpost/BUNpre)) × (UF / 体重)</div>
            <div>nPCR（簡易） ≈ clamp((BUNpre / 60) × 1.2, 0.5, 1.6)</div>
            <div>GNRI = 1.489 × Alb(g/L) + 41.7 × (体重 / 理想体重)</div>
            <div style="margin-top:8px"><strong>塩分推定（尿データ）</strong><br>Na(mg/day)=尿Na(mEq/L)×尿量(L)×23 → 食塩(g)=Na(mg)/1000×2.54</div>
            <div style="margin-top:6px"><strong>塩分推定（IDWG目安）</strong><br>推定食塩(g/day) ≈ 3 + 4 × IDWG(kg)（目安）</div>
          </div>
        </div>

        <div id="results" class="card" style="margin-top:12px;display:none">
          <strong id="resTitle">結果</strong>
          <div class="small" id="resSub">—</div>

          <div id="resultBody" style="margin-top:8px"></div>

          <div id="advice" class="advice" style="display:none">
            <strong>AIアドバイス</strong>
            <ul id="adviceList"></ul>

            <div class="note" style="margin-top:8px;color:#d9534f;font-weight:600">
              ※本ツールは補助目的です。最終的な判断は必ず医師の指示に従ってください。
            </div>
          </div>
        </div>
      </aside>
    </main>

    <div class="small" style="margin-top:12px">© 天陽会 — 作成者：CE（U）</div>
  </div>

  <script>
    // Helpers
    const el = id => document.getElementById(id);
    const isNum = v => { if(v===null||v===undefined) return false; const n = Number(String(v).replace(/,/g,'.')); return !isNaN(n) && isFinite(n); };
    const toNum = v => isNum(v) ? Number(String(v).replace(/,/g,'.')) : null;

    // Set today's date
    (function(){ const d = el('examDate'); if(d){ const t = new Date(); d.value = t.toISOString().slice(0,10); } })();

    // Update IDWG automatically
    function updateIDWG(){
      const pre = toNum(el('weightPre').value);
      const post = toNum(el('weightPost').value);
      if(isNum(pre) && isNum(post)){
        const idwg = pre - post;
        el('idwg').value = idwg.toFixed(2);
        el('idwgInput').value = idwg.toFixed(2);
      } else {
        el('idwg').value = '';
        el('idwgInput').value = '';
      }
    }
    ['weightPre','weightPost'].forEach(id => el(id)?.addEventListener('input', () => { updateIDWG(); updateRunState(); }));

    // Salt estimation helpers
    function estimateSaltFromUrine(){
      const urineNa = toNum(el('urineNa').value);
      const urineVol = toNum(el('urineVol').value);
      if(isNum(urineNa) && isNum(urineVol) && urineVol > 0){
        const na_mg = urineNa * urineVol * 23; // mg/day
        const salt_g = na_mg / 1000 * 2.54; // g/day
        return Number(salt_g.toFixed(2));
      }
      return null;
    }
    function estimateSaltFromIDWG(idwg){
      const s = 3 + 4 * idwg;
      return Number(s.toFixed(2));
    }

    // Main calculation
    function calcAll(){
      const patientId = el('patientId').value.trim();
      const examDate = el('examDate').value;
      const K = toNum(el('K').value);
      const Ca = toNum(el('Ca').value);
      const Alb = toNum(el('Alb').value);
      const P = toNum(el('P').value);
      const iPTH = toNum(el('iPTH').value);
      const Hb = toNum(el('Hb').value);
      const Fe = toNum(el('Fe').value);
      const TIBC = toNum(el('TIBC').value);
      const Ferritin = toNum(el('Ferritin').value);
      const BUNpre = toNum(el('BUNpre').value);
      const BUNpost = toNum(el('BUNpost').value);
      const dialysisTime = toNum(el('dialysisTime').value);
      const UF = toNum(el('UF').value);
      const height = toNum(el('height').value);
      const weightPre = toNum(el('weightPre').value);
      const weightPost = toNum(el('weightPost').value);
      const saltManual = toNum(el('saltManual').value);
      const idwgInput = toNum(el('idwgInput').value);

      // corrected Ca
      const correctedCa = (isNum(Ca) && isNum(Alb)) ? Number((Ca + 0.8 * (4.0 - Alb)).toFixed(2)) : null;

      // TSAT
      const TSAT = (isNum(Fe) && isNum(TIBC) && TIBC !== 0) ? Number(((Fe / TIBC) * 100).toFixed(1)) : null;
      if(TSAT !== null) el('TSAT')?.remove?.();

      // spKtV (簡易 Daugirdas)
      let spKtV = null;
      if(isNum(BUNpre) && isNum(BUNpost) && isNum(dialysisTime) && dialysisTime > 0 && isNum(UF) && isNum(weightPre) && weightPre > 0){
        const t = dialysisTime / 60;
        const R = BUNpost / BUNpre;
        try{
          spKtV = -Math.log(R - 0.008 * t) + (4 - 3.5 * R) * (UF / weightPre);
          spKtV = Number(spKtV.toFixed(3));
        }catch(e){
          spKtV = null;
        }
      }

      // nPCR (簡易推定)
      let nPCR = null;
      if(isNum(BUNpre) && isNum(weightPre) && weightPre > 0){
        let v = (BUNpre / 60) * 1.2;
        v = Math.max(0.5, Math.min(1.6, v));
        nPCR = Number(v.toFixed(2));
      }

      // GNRI
      let GNRI = null;
      if(isNum(Alb) && isNum(height) && isNum(weightPre) && height > 0){
        const idealW = 22 * (height / 100) * (height / 100);
        GNRI = 1.489 * (Alb * 10) + 41.7 * (weightPre / idealW);
        GNRI = Number(GNRI.toFixed(1));
      }

      // Salt selection: manual > urine > IDWG estimate
      let salt = null; let saltSource = '';
      if(isNum(saltManual)){ salt = saltManual; saltSource = '手入力'; }
      else {
        const urineSalt = estimateSaltFromUrine();
        if(urineSalt !== null){ salt = urineSalt; saltSource = '尿データ推定'; }
        else if(isNum(idwgInput)){ salt = estimateSaltFromIDWG(idwgInput); saltSource = 'IDWG推定（目安）'; }
      }

      // Checks with updated targets:
      const checks = {
        spKtV: spKtV !== null ? (spKtV >= 1.4) : null,                       // changed to 1.4
        Hb: Hb !== null ? (Hb >= 10 && Hb <= 12) : null,
        TSAT: TSAT !== null ? (TSAT >= 20) : null,
        Ferritin: Ferritin !== null ? (Ferritin >= 100 && Ferritin <= 300) : null,
        P: P !== null ? (P >= 3.5 && P <= 5.5) : null,                       // changed upper to 5.5
        correctedCa: correctedCa !== null ? (correctedCa >= 8.4 && correctedCa <= 9.5) : null, // changed upper to 9.5
        iPTH: iPTH !== null ? (iPTH >= 60 && iPTH <= 240) : null,
        salt: salt !== null ? (salt < 6) : null,
        nPCR: nPCR !== null ? (nPCR >= 0.9 && nPCR <= 1.2) : null,
        GNRI: GNRI !== null ? (GNRI >= 92) : null,
        Alb: Alb !== null ? (Alb >= 3.5) : null,
        K: K !== null ? (K >= 3.5 && K <= 5.5) : null
      };

      // Render results
      const res = el('results');
      el('resTitle').textContent = '結果';
      el('resSub').textContent = (patientId ? patientId + ' / ' : '') + (examDate || '');

      const body = el('resultBody');
      body.innerHTML = '';

      const rows = [
        ['spKt/V', spKtV, '≥ 1.4', checks.spKtV],
        ['K (mmol/L)', K, '3.5–5.5', checks.K],
        ['Hb (g/dL)', Hb, '10–12', checks.Hb],
        ['TSAT (%)', TSAT, '≥ 20', checks.TSAT],
        ['Ferritin (ng/mL)', Ferritin, '100–300', checks.Ferritin],
        ['P (mg/dL)', P, '3.5–5.5', checks.P],
        ['補正Ca (mg/dL)', correctedCa, '8.4–9.5', checks.correctedCa],
        ['iPTH (pg/mL)', iPTH, '60–240', checks.iPTH],
        ['nPCR (g/kg/day)', nPCR, '0.9–1.2', checks.nPCR],
        ['GNRI', GNRI, '≥ 92', checks.GNRI],
        ['Alb (g/dL)', Alb, '≥ 3.5', checks.Alb],
        ['塩分 (g/day)', salt !== null ? salt : '—', '< 6', checks.salt]
      ];

      let html = '<table><thead><tr><th>項目</th><th>値</th><th>目標</th><th>判定</th></tr></thead><tbody>';
      rows.forEach(r => {
        const status = r[3];
        const cls = status === true ? 'ok' : (status === false ? 'warn' : '');
        const label = status === true ? '<span class="ok">OK</span>' : (status === false ? '<span class="warn">要対応</span>' : '<span class="small">未入力</span>');
        const val = (r[1] === null || r[1] === undefined) ? '—' : r[1];
        html += `<tr><td>${r[0]}</td><td>${val}</td><td>${r[2]}</td><td class="${cls}">${label}</td></tr>`;
      });
      html += '</tbody></table>';
      html += `<div class="note">塩分推定根拠: ${saltSource || '未推定'}</div>`;
      body.innerHTML = html;

      // AI advice (rule-based)
      const adv = [];
      if(checks.spKtV === false) adv.push('spKt/V が目標未達です。透析時間延長や血流量増加、アクセス評価を検討してください。');
      if(checks.Hb === false) adv.push('貧血（Hb）が目標外です。ESAや鉄補充の検討、出血や炎症の評価を行ってください。');
      if(checks.TSAT === false || checks.Ferritin === false) adv.push('鉄代謝指標が目標外です。鉄補充の必要性を検討してください。');
      if(checks.P === false) adv.push('リンが目標外です。食事指導やリン吸着薬の調整を検討してください。');
      if(checks.correctedCa === false || checks.iPTH === false) adv.push('MBD 指標が目標外です。薬剤やビタミンDの調整を検討してください。');
      if(checks.nPCR === false || checks.GNRI === false || checks.Alb === false) adv.push('栄養指標が不良です。栄養士による評価と介入を検討してください。');
      if(checks.K === false) adv.push('カリウムが目標外です。食事指導や透析条件の見直しを検討してください。');
      if(checks.salt === false) adv.push('塩分摂取が目標を超えています。食事指導で塩分制限を検討してください。');

      const advEl = el('advice');
      const advList = el('adviceList');
      if(adv.length > 0){
        advEl.style.display = 'block';
        advList.innerHTML = adv.map(a => `<li>${a}</li>`).join('');
      } else {
        advEl.style.display = 'block';
        advList.innerHTML = '<li>全体的に目標範囲内です。現行治療を継続してください。</li>';
      }

      res.style.display = 'block';
      return { results: rows, checks };
    }

    // Estimate salt button
    el('estimateSalt').addEventListener('click', () => {
      let idwg = toNum(el('idwgInput').value);
      if(!isNum(idwg)){
        const pre = toNum(el('weightPre').value), post = toNum(el('weightPost').value);
        if(isNum(pre) && isNum(post)) idwg = pre - post;
      }
      if(!isNum(idwg)){ alert('IDWG（透析前後体重差）を入力してください'); return; }
      const est = (3 + 4 * idwg).toFixed(2);
      el('saltManual').value = est;
      alert('IDWGベース推定（目安）: 推定塩分 = ' + est + ' g/day（手入力欄に反映しました）');
    });

    // Run, Print, Clear
    el('runAnalyze').addEventListener('click', () => { try{ calcAll(); } catch(e){ console.error(e); alert('解析エラー'); } });
    el('printBtn').addEventListener('click', () => { window.print(); });

    el('clearBtn').addEventListener('click', () => {
      const ids = ['patientId','K','Alb','Ca','P','iPTH','Hb','Fe','TIBC','Ferritin','BUNpre','BUNpost','dialysisTime','UF','height','weightPre','weightPost','idwg','idwgInput','saltManual','urineNa','urineVol'];
      ids.forEach(id => { const e = el(id); if(!e) return; e.value = ''; });
      // reset date to today
      const d = el('examDate'); if(d){ const t = new Date(); d.value = t.toISOString().slice(0,10); }
      // hide results
      const res = el('results'); if(res) res.style.display = 'none';
      updateRunState();
    });

    // Enable run button only when minimal inputs present
    function updateRunState(){
      const required = ['K','Ca','Alb','height'];
      const ok = required.every(id => { const v = el(id).value.trim(); return v !== '' && isNum(v); });
      el('runAnalyze').disabled = !ok;
    }
    ['K','Ca','Alb','height','weightPre','weightPost'].forEach(id => el(id)?.addEventListener('input', () => { updateIDWG(); updateRunState(); }));
    updateRunState();

    // Expose for console
    window.computeAll = calcAll;

    // Shortcut: Ctrl/Cmd + Enter
    document.addEventListener('keydown', function(e){
      if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){ try{ calcAll(); } catch(err){ console.error(err); } }
    });
  </script>
</body>
</html>
